@model BeePM.Models.ApprovalFlow
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Flow Designer";
}

<h2>Flow Designer - @Model.Name</h2>
<hr />

<!-- BPMN Designer Alanı -->
<div id="canvas" style="width:100%; height:600px; border:1px solid #ccc;"></div>

<div class="mt-3">
    <button id="btnSaveFlow" class="btn btn-success">💾 Kaydet</button>
    <a asp-action="Index" class="btn btn-secondary">⬅ Geri Dön</a>
</div>

@section Scripts {
    <!-- BPMN.io CSS + JS -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/bpmn-font/css/bpmn.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-js.css" />

    <script src="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-modeler.development.js"></script>

    <script>
                // DB’den gelen BPMN XML
                var flowJson = `@Html.Raw((ViewBag.FlowJson ?? "{}").ToString().Replace("`", "\\`"))`;

                // BPMN Modeler initialize (palette ve klavye desteği aktif)
                var bpmnModeler = new BpmnJS({
                    container: '#canvas',
                    keyboard: { bindTo: window }
                });

                // Eğer DB’de kayıtlı BPMN varsa yükle
                if (flowJson && flowJson !== "{}") {
                    bpmnModeler.importXML(flowJson).then(() => {
                        console.log("✅ BPMN Yüklendi");
                        bpmnModeler.get('canvas').zoom('fit-viewport'); // otomatik sığdır
                    }).catch(err => {
                        console.error("❌ BPMN yüklenemedi", err);
                    });
                } else {
                    // Boş diyagram başlat
                    const defaultDiagram = `<?xml version="1.0" encoding="UTF-8"?>
        <bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
            xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
            xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
            targetNamespace="http://bpmn.io/schema/bpmn">
          <bpmn:process id="Process_1" isExecutable="false">
            <bpmn:startEvent id="StartEvent_1"/>
          </bpmn:process>
          <bpmndi:BPMNDiagram id="BPMNDiagram_1">
            <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
              <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
                <dc:Bounds x="179" y="79" width="36" height="36"/>
              </bpmndi:BPMNShape>
            </bpmndi:BPMNPlane>
          </bpmndi:BPMNDiagram>
        </bpmn:definitions>`;

                    bpmnModeler.importXML(defaultDiagram).then(() => {
                        bpmnModeler.get('canvas').zoom('fit-viewport');
                    });
                }

                // Kaydet butonu
                $('#btnSaveFlow').click(async function () {
                    try {
                        const { xml } = await bpmnModeler.saveXML({ format: true });

                        $.ajax({
                            url: '/FlowDesigner/Save',
                            type: 'POST',
                            data: { id: @Model.Id, flowJson: xml },
                            success: function (res) {
                                if (res.success) {
                                    alert("✔ Süreç kaydedildi!");
                                } else {
                                    alert("❌ Kaydetme hatası");
                                }
                            }
                        });
                    } catch (err) {
                        console.error("Kaydetme hatası:", err);
                        alert("❌ BPMN export edilemedi");
                    }
                });
    </script>
}
