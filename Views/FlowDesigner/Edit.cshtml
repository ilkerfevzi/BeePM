@model BeePM.Models.ApprovalFlow
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Flow Designer";
}

<h2>Flow Designer - @Model.Name</h2>
<hr />

<div id="canvas" style="width:100%; height:600px; border:1px solid #ccc;"></div>

<div class="mt-3 d-flex gap-2">
    <button id="btnSaveFlow" class="btn btn-success">💾 Kaydet</button>
    <a asp-action="Index" class="btn btn-secondary">⬅ Geri Dön</a>
</div>

@section Scripts {
    <!-- BPMN.io CSS -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/bpmn-font/css/bpmn.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-js.css" />
    <!-- BPMN.io JS (Modeler: palette + modeling içerir) -->
    <script src="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-modeler.development.js"></script>

    <script>
        // DB'den gelen BPMN XML (boşsa "{}" gelir)
        const flowXml = `@Html.Raw((ViewBag.FlowJson ?? "{}").ToString().Replace("`", "\\`"))`;

        // Modeler (palette + klavye)
        const bpmnModeler = new BpmnJS({
            container: '#canvas',
            keyboard: { bindTo: window }
        });

        // XML import etmeyi dene, olmazsa createDiagram fallback kullan
        (async function init() {
            try {
                if (flowXml && flowXml !== "{}") {
                    await bpmnModeler.importXML(flowXml);
                } else {
                    await bpmnModeler.createDiagram(); // hazır boş BPMN
                }
                bpmnModeler.get('canvas').zoom('fit-viewport');
                console.log('✅ BPMN hazır');
            } catch (e) {
                console.warn('XML import hatası, boş diagram açılıyor:', e);
                await bpmnModeler.createDiagram();
                bpmnModeler.get('canvas').zoom('fit-viewport');
            }
        })();

        // Kaydet (fetch ile)
        document.getElementById('btnSaveFlow').addEventListener('click', async () => {
            try {
                const { xml } = await bpmnModeler.saveXML({ format: true });
                const form = new FormData();
                form.append('id', '@Model.Id');
                form.append('flowJson', xml);

                const res = await fetch('/FlowDesigner/Save', { method: 'POST', body: form });
                const data = await res.json();

                if (data?.success) alert('✔ Süreç kaydedildi!');
                else alert('❌ Kaydetme hatası');
            } catch (err) {
                console.error('Kaydetme hatası:', err);
                alert('❌ BPMN export edilemedi');
            }
        });
    </script>
}
